<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>图片图层</title>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "5532bc203fa1693f6780cfafcdcbbafb",
        };
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=c3dd92f447429606c242fd5fe4f561c3&plugin=AMap.Walking"></script>
    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
    <style>
        /* #container {
            margin: auto;
            padding: 0;
            width: 50vw;
            height: 50vh;
            transform: translate(0, 50%);

        } */
        html,
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #container {
            width: 100%;
            height: 100vh;
        }

        #panel {
            position: fixed;
            background-color: white;
            max-height: 90%;
            overflow-y: auto;
            top: 10px;
            right: 10px;
            width: 280px;
            z-index: 888;
        }

        #panel .amap-call {
            background-color: #009cf9;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        #panel .amap-lib-walking {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            overflow: hidden;
        }

        .btns {
            position: absolute;
            left: 20px;
            bottom: 20px;
            display: flex;
            z-index: 9999;
        }

        .btn {
            text-align: center;
            padding: 20px;
            background-color: aqua;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 20px;
            color: red;
        }
        #panel2 {
            position: fixed;
            background-color: white;
            max-height: 90%;
            overflow-y: auto;
            top: 10px;
            right: 10px;
            left: 10px;
            /* bottom: 10px; */
            z-index: 888;
            border-radius: 20px;
            padding-bottom: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="btns">
            <div class="btn claerMap">清除所有图层</div>
            <div class="btn addbtn">添加标记点</div>
            <div class="btn selectLine">标记推荐路线</div>
            <div class="btn selectEnd">完成标记</div>
            <div class="btn mockSellLine">模拟导航推荐路线</div>
            <div class="btn clearMarker">清除上一次标记</div>
        </div>
        <div id="panel"></div>
        <div id="panel2">
            <h3>这是一个标识点信息窗口</h3>
            <div class="btn mockbtn">模拟导航</div>
        </div>
    </div>


    <script>

        var markerData = [
            [106.503609,29.504015],
            [106.503745,29.503897],
            [106.508003,29.501885]
        ]
        var imageLayer = new AMap.ImageLayer({
            url: './images/animal.png',
            bounds: new AMap.Bounds(
                 [106.498015,29.499104],
                [106.513916,29.510025]
            ),
            zooms: [16.5, 18],
            opacity: 1
        });
        var imageLayer2 = new AMap.ImageLayer({
            url: './images/animal.png',
            bounds: new AMap.Bounds(
                [106.498015,29.499104],
                [106.513916,29.510025]
            ),
            zooms: [18, 19],
            opacity: 1
        });
        var map = new AMap.Map('container', {
            center: [106.505799, 29.504023],
            zooms: [16.5, 19],
            layers: [
                AMap.createDefaultLayer(),
                imageLayer,
                imageLayer2
            ],
            viewMode: '2D',
            // mapStyle:'amap://styles/fresh',
            // pitch: 40,
            features: []
        });


        // 获取定位
        // getPosition()

        //保存创建的marker
        let markers = []
       
        //当前点击标识点坐标
        let endPosition
        // 将标记点添加到地图上
        let btn = document.querySelector('.addbtn')
        btn.addEventListener('click', () => {
            if (markers.length) {
                map.remove(markers)
                markers = []
                return
            }
            clearAllLayers()
            markerData.forEach(item => {

                let marker = new AMap.Marker({
                    position: item,
                });

                marker.on('click', function () {
                    // 在点击事件的处理函数中，缩放并定位到标记点
                    document.querySelector('#panel2').style.display = 'block'
                    endPosition = marker.getPosition()
                    // map.setZoomAndCenter(18, marker.getPosition());

                });
                map.add(marker);
                markers.push(marker)
            });
            map.setFitView()
        })

        var currentPosition = null
        //实例化步行导航
        let walking = new AMap.Walking({
            map: map,
            // panel: "panel"
        });
        let movePath = null
        //步行路线规划导航
        function startWalking(endPosition) {
            clearAll()

            //根据起终点坐标规划步行路线
            //  walking.search(currentPosition, endPosition, function (status, result) {
            walking.search(map.getCenter(), endPosition, function (status, result) {
                // result即是对应的步行路线数据信息，相关数据结构文档请参考  https://lbs.amap.com/api/javascript-api/reference/route-search#m_WalkingResult
                if (status === 'complete') {
                    console.log('绘制步行路线完成')
                    movePath = parseRouteToPath(result.routes[0])
                    // mockMove(movePath)
                     mockMove(movePath)
                } else {
                    console.error('步行路线数据查询失败' + result)
                }
            });
        }
        //模拟导航
        let animationMarker = null
        function mockMove(path) {
            if (animationMarker) {
                animationMarker.stopMove();
                animationMarker.setMap(null);
                animationMarker = null;
            }


            AMap.plugin('AMap.MoveAnimation', function () {
                // 创建 AMap.Icon 实例
                const icon = new AMap.Icon({
                    size: new AMap.Size(20, 20), // 设置图标的尺寸
                    image: './images/navIcon.png', // 图标的URL
                    imageSize: new AMap.Size(20, 20) // 根据所设置的大小拉伸或压缩图片
                });


                animationMarker = new AMap.Marker({
                    map: map,
                    icon: icon,
                    position: [106.505799, 29.504023],
                    anchor: 'center'
                });
                animationMarker.on('moving', function (e) {
                    // passedPolyline.setPath(e.passedPath);
                    map.setCenter(e.target.getPosition(), true)
                    // map.setFitView(animationMarker)

                });

                animationMarker.moveAlong(path, {
                    // 每一段的时长
                    duration: 1000,//可根据实际采集时间间隔设置
                    // JSAPI2.0 是否延道路自动设置角度在 moveAlong 里设置
                    autoRotation: true,
                });

            })
        }
        //清除路线规划
        function clearAll() {
            if (walking) {
                walking.clear()
            }
            if (animationMarker) {
                animationMarker.stopMove();
                animationMarker.setMap(null);
                animationMarker = null;
            }
        }
        function getPosition() {
            //获取定位信息
            var options = {
                'showButton': true,//是否显示定位按钮
                'position': 'LT',//定位按钮的位置
                /* LT LB RT RB */
                'offset': [10, 20],//定位按钮距离对应角落的距离
                'showMarker': true,//是否显示定位点
                'markerOptions': {//自定义定位点样式，同Marker的Options
                    'offset': new AMap.Pixel(-18, -36),
                    'content': '<img src="https://a.amap.com/jsapi_demos/static/resource/img/user.png" style="width:36px;height:36px"/>'
                },
                'showCircle': true,//是否显示定位精度圈
                'circleOptions': {//定位精度圈的样式
                    'strokeColor': '#0093FF',
                    'noSelect': true,
                    'strokeOpacity': 0.5,
                    'strokeWeight': 1,
                    'fillColor': '#02B0FF',
                    'fillOpacity': 0.25
                },
                panToLocation: false
            }

            AMap.plugin(["AMap.Geolocation"], function () {
                var geolocation = new AMap.Geolocation(options);
                map.addControl(geolocation);
                geolocation.watchPosition(function (status, result) {
                    if (status == 'complete') {
                        currentPosition = result.position
                        console.log('定位成功')
                    } else {
                        console.log('定位失败')
                    }
                })
            });
        }



        // 清除 marker
        let mockbtn = document.querySelector('.mockbtn')
        mockbtn.addEventListener('click', () => {
            // if(!currentPosition) return alert('正在获取当前定位')
            // if (!movePath) return alert('请先选择标记点规划路线')
            if(endPosition){
                document.querySelector('#panel2').style.display = 'none'
                 startWalking(endPosition)
            }
           
           
        })

        // 限制地图显示范围
        function lockMapBounds() {
            // var bounds = new AMap.Bounds(
            //     [116.325367, 39.935626],
            //     [116.345236, 39.950745]
            // );
            var bounds = new AMap.Bounds(
                [106.498015,29.499104],
                [106.513916,29.510025]
                
            );
            map.setLimitBounds(bounds);
            // logMapInfo();
        }

        //启用地图范围限定
        lockMapBounds();
        // logMapInfo();

        // 这是一个表示矩形区域四个角的经纬度坐标数组
        var path = [
            [116.327812, 39.942785], // 西南角
            [116.3279, 39.942792],// 西北角
            [116.328727, 39.943189], // 东北角
            [116.328915, 39.943201],  // 东南角
            [116.328903, 39.943399], // 西南角
            [116.328934, 39.943472],// 西北角
            [116.329526, 39.943565], // 东北角
            [116.329503, 39.943728]
            [116.330397, 39.943831], // 西南角
            [116.330513, 39.944013],// 西北角
            [116.330592, 39.944053], // 东北角
            [116.331242, 39.944106]
            [116.331489, 39.944182], // 西南角
            [116.332053, 39.944252],// 西北角
            [116.332294, 39.944241], // 东北角
            [116.332436, 39.944268]
            [116.333311, 39.944241], // 西南角
            [116.333311, 39.944241],// 西北角
            [116.333538, 39.945194], // 东北角
            [116.335126, 39.945349]
            [116.335228, 39.944813], // 西南角
            [116.336278, 39.944877],// 西北角
            [116.337558, 39.945053], // 东北角
            [116.33751, 39.945403],
            [116.338879, 39.94551], // 西南角
            [116.339707, 39.946312],// 西北角
            [116.339546, 39.947512], // 东北角
            [116.340558, 39.947559]
            [116.3407, 39.946518], // 西南角
            [116.340686, 39.946344],// 西北角
            [116.340518, 39.946182], // 东北角
            [116.340547, 39.946012]
            [116.341043, 39.946027], // 西南角
            [116.341053, 39.945805],// 西北角
            [116.341553, 39.945849], // 东北角
            [116.342563, 39.945858]
            [116.34257, 39.943903], // 西南角
            [116.342513, 39.943248],// 西北角
            [116.343181, 39.943081], // 东北角
            [116.343345, 39.942413],
            [116.343113, 39.942394]
            [116.343019, 39.941276], // 西南角
            [116.34269, 39.941176],// 西北角
            [116.342714, 39.938742], // 东北角
            [116.335884, 39.938419],
            [116.33584, 39.93843], // 西南角
            [116.335734, 39.938801],// 西北角
            [116.335627, 39.939425], // 东北角
            [116.335598, 39.939573]
            [116.334039, 39.939484], // 西南角
            [116.33081, 39.939503],// 西北角
            [116.330742, 39.938638], // 东北角
            [116.330432, 39.938701]
            [116.330486, 39.939339], // 西南角
            [116.330147, 39.939952],// 西北角
            [116.32899, 39.940078], // 东北角
            [116.328491, 39.940891]
            [116.327838, 39.942598], // 西南角
            [116.327707, 39.942747],// 西北角
            [116.343181, 39.943081], // 东北角
            [116.343345, 39.942413]
        ];

        // // //两江数字园地图
        // let path2 = [
        //     [106.499426, 29.509774],
        //     [106.513249, 29.509787],
        //     [106.513264, 29.498959],
        //     [106.499123, 29.499038]
        // ]
        // map.setMask([path2]); // 设置 mask 路径



        // 解析WalkRoute对象，构造成AMap.Polyline的path参数需要的格式
        // WalkRoute对象的结构文档 https://lbs.amap.com/api/javascript-api/reference/route-search#m_WalkRoute
        function parseRouteToPath(route) {
            let path = []

            for (var i = 0, l = route.steps.length; i < l; i++) {
                var step = route.steps[i]

                for (var j = 0, n = step.path.length; j < n; j++) {
                    path.push(step.path[j])
                }
            }

            return path
        }

        //标记推荐路线
        const selectLineDom = document.querySelector('.selectLine')
        const selectEndDom = document.querySelector('.selectEnd')
        // const showLine = document.querySelector('.showLine')
        const clearMarker = document.querySelector('.clearMarker')
        const mockSellLine = document.querySelector('.mockSellLine')
        let selectLineArray = []
        let completeLineArray
        let lineMarkers = []
        let selectLineMapArray = []
        let isComplete = false
        let isSelectedLine = false
        // 新实例一个walking对象
        let selectWalking = new AMap.Walking();
        // 定义点击事件的处理函数
        function onMapClick(ev) {
            var target = ev.target;
            var lnglat = ev.lnglat;
            var pixel = ev.pixel;
            selectLineArray.push(lnglat);
            // console.log(selectLineArray)
            if (selectLineArray.length > 1) {
                if (lineMarkers.length > 1) {
                    map.remove(lineMarkers[lineMarkers.length - 1])
                    lineMarkers.splice(-1, 1)
                }
                drawRoute(selectLineArray)
            }

            // if (selectLineArray.length > 1) {
            //     if(lineMarkers.length > 1){
            //         map.remove(lineMarkers[lineMarkers.length-1])
            //         lineMarkers.slice(-1, 1)
            //     }
            //     selectWalking.search(selectLineArray[selectLineArray.length - 2], selectLineArray[selectLineArray.length - 1], function (status, result) {
            //         // result即是对应的步行路线数据信息，相关数据结构文档请参考  https://lbs.amap.com/api/javascript-api/reference/route-search#m_WalkingResult
            //         if (status === 'complete') {
            //             console.log(result)
            //             // completeLineArray.push(parseRouteToPath(result.routes[0]))
            //             drawRoute(parseRouteToPath(result.routes[0]))
            //         } else {
            //             console.error('步行路线数据查询失败' + result)
            //         }
            //     });
            // }
        }
        selectLineDom.addEventListener('click', () => {
            if(isSelectedLine) return alert('正在标记路线中')
            isSelectedLine = true
            isComplete = false
            selectLineArray = []
            completeLineArray = []
            clearAllLayers()
            map.on("click", onMapClick);
            map.setDefaultCursor('pointer')
        })

        // 定义一个异步函数来发起请求
        async function getLineData(param1, param2) {
            const url = `https://restapi.amap.com/v3/direction/walking?origin=${param1}&destination=${param2}&key=c3dd92f447429606c242fd5fe4f561c3`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                console.log('请求成功:', data);
                return data; // 返回响应数据
            } catch (error) {
                console.error('请求失败:', error);
            }
        }
        //完成标记
        selectEndDom.addEventListener('click', async () => {
            if(selectLineArray.length <= 1) return alert('请至少标记两个点')
            map.off('click', onMapClick)
            map.setDefaultCursor('default')
            isSelectedLine = false
            isComplete = true
            // if (selectLineArray.length < 2) return alert('请至少选择两个点')
            // completeLineArray = []
            //     for (let i = 0; i < selectLineArray.length - 1; i++) {
            //             await selectWalking.search(selectLineArray[i], selectLineArray[i + 1], function (status, result) {
            //                 // result即是对应的步行路线数据信息，相关数据结构文档请参考  https://lbs.amap.com/api/javascript-api/reference/route-search#m_WalkingResult
            //                 if (status === 'complete') {
            //                     completeLineArray.push(parseRouteToPath(result.routes[0]))
            //                 } else {
            //                     console.error('步行路线数据查询失败' + result)
            //                 }
            //             });
            //         }
        })
        //绘制推荐路线
        // showLine.addEventListener('click', () => {
        //     console.log(completeLineArray)
        //     drawRoute(completeLineArray)
        // })

        //绘制推荐路线
        let changeColorTimer = null
        function drawRoute(route) {
            var path = route
            // path.forEach((item, index) => {
            //     if (path.length === 1) {
            //         var startMarker = new AMap.Marker({
            //             position: item[0],
            //             icon: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
            //             map: map,
            //             anchor: 'bottom-center',
            //         })
            //         var endMarker = new AMap.Marker({
            //             position: item[item.length - 1],
            //             icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
            //             map: map,
            //             anchor: 'bottom-center',
            //         })
            //         var routeLine = new AMap.Polyline({
            //             path: item,
            //             isOutline: true,
            //             outlineColor: '#ffeeee',
            //             borderWeight: 2,
            //             strokeWeight: 5,
            //             strokeColor: '#0091ff',
            //             strokeOpacity: 0.9,
            //             lineJoin: 'round',
            //             lineCap: 'round',
            //             showDir: true
            //         })

            //         map.add(routeLine);
            //     } else {
            //         if (index === 0) {
            //             var startMarker = new AMap.Marker({
            //                 position: item[0],
            //                 icon: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
            //                 map: map,
            //                 anchor: 'bottom-center',
            //             })

            //             var routeLine = new AMap.Polyline({
            //                 path: item,
            //                 isOutline: true,
            //                 outlineColor: '#ffeeee',
            //                 borderWeight: 2,
            //                 strokeWeight: 5,
            //                 strokeColor: '#0091ff',
            //                 strokeOpacity: 0.9,
            //                 lineJoin: 'round',
            //                 lineCap: 'round',
            //                 showDir: true
            //             })

            //             map.add(routeLine);
            //         } else if (index === (path.length - 1)) {
            //             var startMarker = new AMap.Marker({
            //                 position: item[0],
            //                 map: map,
            //                 anchor: 'bottom-center',
            //             })
            //             var endMarker = new AMap.Marker({
            //                 position: item[item.length - 1],
            //                 icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
            //                 map: map,
            //                 anchor: 'bottom-center',
            //             })
            //             var routeLine = new AMap.Polyline({
            //                 path: item,
            //                 isOutline: true,
            //                 outlineColor: '#ffeeee',
            //                 borderWeight: 2,
            //                 strokeWeight: 5,
            //                 strokeColor: '#0091ff',
            //                 strokeOpacity: 0.9,
            //                 lineJoin: 'round',
            //                 lineCap: 'round',
            //                 showDir: true
            //             })

            //             map.add(routeLine);
            //         } else {
            //             var startMarker = new AMap.Marker({
            //                 position: item[0],
            //                 map: map,
            //                 anchor: 'bottom-center',
            //             })
            //             // var endMarker = new AMap.Marker({
            //             //     position: item[item.length - 1],
            //             //     icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
            //             //     map: map,
            //             //     anchor: 'bottom-center',
            //             // })
            //             var routeLine = new AMap.Polyline({
            //                 path: item,
            //                 isOutline: true,
            //                 outlineColor: '#ffeeee',
            //                 borderWeight: 2,
            //                 strokeWeight: 5,
            //                 strokeColor: '#0091ff',
            //                 strokeOpacity: 0.9,
            //                 lineJoin: 'round',
            //                 lineCap: 'round',
            //                 showDir: true
            //             })

            //             map.add(routeLine);
            //         }
            //     }
            // })
            var startMarker = new AMap.Marker({
                position: path[0],
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                map: map,
                anchor: 'bottom-center',
            })
            var endMarker = new AMap.Marker({
                position: path[path.length - 1],
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                map: map,
                anchor: 'bottom-center',
            })
            var routeLine = new AMap.Polyline({
                path: path,
                isOutline: true,
                outlineColor: '#ffeeee',
                borderWeight: 2,
                strokeWeight: 6,
                strokeColor: '#0091ff',
                strokeOpacity: 0.9,
                lineJoin: 'round',
                lineCap: 'round',
                showDir: true
            })
            // 定义两个颜色
            var color1 = '#0091ff'; // 蓝色
            var color2 = '#1cd66c'; // 绿色

            // 当前颜色标记
            var currentColor = color1;

            if (changeColorTimer) {
                clearInterval(changeColorTimer)
                changeColorTimer = null
            }
            // 使用setInterval来定时更改折线颜色
            changeColorTimer = setInterval(function () {
                // 切换当前颜色
                currentColor = currentColor === color1 ? color2 : color1;

                // 更新折线颜色
                routeLine.setOptions({
                    strokeColor: currentColor
                });
            }, 1000); // 每隔1秒更改一次颜色
            lineMarkers = [...lineMarkers, routeLine, endMarker]

            // selectLineMapArray = [...selectLineMapArray,routeLine]
            map.add(routeLine);

            // 调整视野达到最佳显示区域
            // map.setFitView([startMarker, endMarker, routeLine])
        }
        //模拟导航推荐路线
        mockSellLine.addEventListener('click', () => {
            if(!isComplete || isSelectedLine) return alert('正在标记路线中或请点击完成标记')
            mockMove(selectLineArray)
        })
        //清除上一次标记
        clearMarker.addEventListener('click', () => {
            map.remove([lineMarkers[lineMarkers.length - 1], lineMarkers[lineMarkers.length - 2]])
            //  map.remove(selectLineMapArray[selectLineMapArray.length-1])
            lineMarkers.splice(-2, 2)
            selectLineArray.splice(-1, 1)
            //  selectLineMapArray.slice(-1, 1)
            if (selectLineArray.length > 1) {
                var endMarker = new AMap.Marker({
                    position: selectLineArray[selectLineArray.length - 1],
                    icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                    map: map,
                    anchor: 'bottom-center',
                })
                lineMarkers = [...lineMarkers, endMarker]
                // map.add(routeLine);
            }

        })
        //清除所有覆盖物
        const claerMap = document.querySelector('.claerMap')
        claerMap.addEventListener('click', () => {
            clearAllLayers()
            map.setCenter([106.505799, 29.504023], true)
        })
        // 清除地图上所有的覆盖物
        function clearAllLayers() {
            // 获取除ImageLayer以外的所有覆盖物
            var allOverlays = map.getAllOverlays();
            allOverlays.forEach(function (overlay) {
                if (!(overlay instanceof AMap.ImageLayer)) {
                    map.remove(overlay);
                }
            });
            if (animationMarker) {
                animationMarker.stopMove();
                animationMarker.setMap(null);
                animationMarker = null;
            }
            document.querySelector('#panel2').style.display = 'none'
        }

    </script>
</body>

</html>